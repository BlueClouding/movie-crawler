<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8è§†é¢‘æ’­æ”¾å™¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .content {
            padding: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #007bff;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
        }
        
        .btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108,117,125,0.4);
        }
        
        .video-container {
            margin-top: 30px;
            text-align: center;
        }
        
        #videoPlayer {
            width: 100%;
            max-width: 800px;
            height: 450px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
        
        .preset-links {
            margin-top: 20px;
        }
        
        .preset-link {
            display: inline-block;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .preset-link:hover {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ M3U8è§†é¢‘æ’­æ”¾å™¨</h1>
            <p>æ”¯æŒHLSæµåª’ä½“æ’­æ”¾ï¼Œè‡ªåŠ¨å¤„ç†è·¨åŸŸå’Œé˜²ç›—é“¾</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <div class="input-group">
                    <label for="m3u8Url">M3U8è§†é¢‘é“¾æ¥:</label>
                    <input type="text" id="m3u8Url" placeholder="è¯·è¾“å…¥M3U8é“¾æ¥..." 
                           value="https://faf8b60b.freshvibe64.store/blah3/XEn0ezAekFvTgxX3A7ZKZY_9hxR3jYNOCqeLthCPgxdQyIZi/video.m3u8">
                </div>
                
                <div class="input-group">
                    <label for="refererUrl">Referer (é˜²ç›—é“¾):</label>
                    <input type="text" id="refererUrl" placeholder="è¯·è¾“å…¥Referer URL..." 
                           value="https://surrit.store/">
                </div>
                
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="useProxy" checked> ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ (æ¨è)
                    </label>
                    <small style="color: #666; display: block; margin-top: 5px;">
                        âœ… è‡ªåŠ¨è§£å†³è·¨åŸŸé—®é¢˜å’ŒRefererè®¾ç½®
                    </small>
                </div>
                
                <button class="btn" onclick="loadVideo()">ğŸ¥ åŠ è½½è§†é¢‘</button>
                <button class="btn btn-secondary" onclick="clearVideo()">ğŸ—‘ï¸ æ¸…é™¤</button>
                <button class="btn btn-secondary" onclick="testConnection()">ğŸ” æµ‹è¯•è¿æ¥</button>
                <button class="btn btn-secondary" onclick="openProxy()">ğŸ”„ ä»£ç†æœåŠ¡å™¨</button>
                <button class="btn btn-secondary" onclick="debugConnection()">ğŸ”§ è°ƒè¯•ä¿¡æ¯</button>
            </div>
            
            <div class="info-box">
                <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
                <ul>
                    <li><strong>M3U8é“¾æ¥:</strong> è¾“å…¥è¦æ’­æ”¾çš„HLSè§†é¢‘æµé“¾æ¥</li>
                    <li><strong>Referer:</strong> è®¾ç½®é˜²ç›—é“¾æ¥æºï¼Œé€šå¸¸æ˜¯è§†é¢‘ç½‘ç«™çš„åŸŸå</li>
                    <li><strong>è‡ªåŠ¨å¤„ç†:</strong> æ’­æ”¾å™¨ä¼šè‡ªåŠ¨å¤„ç†è·¨åŸŸå’Œè¯·æ±‚å¤´è®¾ç½®</li>
                    <li><strong>å…¼å®¹æ€§:</strong> æ”¯æŒç°ä»£æµè§ˆå™¨çš„HLSæ’­æ”¾</li>
                </ul>
            </div>
            
            <div id="statusMessage"></div>
            
            <div class="video-container">
                <video id="videoPlayer" controls preload="none" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='450' viewBox='0 0 800 450'%3E%3Crect width='800' height='450' fill='%23f8f9fa'/%3E%3Ctext x='400' y='225' text-anchor='middle' fill='%23666' font-size='24' font-family='Arial'%3Eç‚¹å‡»åŠ è½½è§†é¢‘æ’­æ”¾%3C/text%3E%3C/svg%3E">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                </video>
            </div>
            
            <div class="preset-links">
                <h4>ğŸ”— å¿«é€Ÿé“¾æ¥:</h4>
                <div class="preset-link" onclick="setPresetUrl('https://faf8b60b.freshvibe64.store/blah3/XEn0ezAekFvTgxX3A7ZKZY_9hxR3jYNOCqeLthCPgxdQyIZi/video.m3u8', 'https://surrit.store/')">
                    ğŸ“º ç¤ºä¾‹è§†é¢‘é“¾æ¥
                </div>
                <div class="preset-link" onclick="setProxyExample()">
                    ğŸ”„ ä»£ç†æ¨¡å¼ç¤ºä¾‹
                </div>
                <div class="preset-link" onclick="setPresetUrl('', 'https://surrit.store/')">
                    ğŸ—‘ï¸ æ¸…ç©ºé“¾æ¥
                </div>
            </div>
        </div>
    </div>
    
    <!-- HLS.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <script>
        let hls = null;
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // 3ç§’åè‡ªåŠ¨æ¸…é™¤çŠ¶æ€æ¶ˆæ¯
            setTimeout(() => {
                if (statusDiv.innerHTML.includes(message)) {
                    statusDiv.innerHTML = '';
                }
            }, 3000);
        }
        
        function setPresetUrl(m3u8Url, refererUrl) {
            document.getElementById('m3u8Url').value = m3u8Url;
            document.getElementById('refererUrl').value = refererUrl;
        }
        
        function setProxyExample() {
            document.getElementById('m3u8Url').value = 'https://faf8b60b.freshvibe64.store/blah3/XEn0ezAekFvTgxX3A7ZKZY_9hxR3jYNOCqeLthCPgxdQyIZi/video.m3u8';
            document.getElementById('refererUrl').value = 'https://surrit.store/';
            document.getElementById('useProxy').checked = true;
            showStatus('âœ… å·²è®¾ç½®ä»£ç†æ¨¡å¼ç¤ºä¾‹ï¼Œç‚¹å‡»"åŠ è½½è§†é¢‘"å¼€å§‹æ’­æ”¾', 'success');
        }
        
        function openProxy() {
            window.open('http://localhost:8001/', '_blank');
        }
        
        function debugConnection() {
            const m3u8Url = document.getElementById('m3u8Url').value.trim();
            const refererUrl = document.getElementById('refererUrl').value.trim();
            const useProxy = document.getElementById('useProxy').checked;
            
            console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
            console.log('M3U8 URL:', m3u8Url);
            console.log('Referer URL:', refererUrl);
            console.log('ä½¿ç”¨ä»£ç†:', useProxy);
            
            if (useProxy) {
                const proxyUrl = buildProxyUrl(m3u8Url, refererUrl);
                console.log('ä»£ç†URL:', proxyUrl);
                
                // æµ‹è¯•ä»£ç†æœåŠ¡å™¨è¿æ¥
                fetch('http://localhost:8001/')
                    .then(response => {
                        console.log('ä»£ç†æœåŠ¡å™¨çŠ¶æ€:', response.status);
                        showStatus(`ğŸ”§ è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°\nä»£ç†æœåŠ¡å™¨çŠ¶æ€: ${response.status === 200 ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, 'info');
                    })
                    .catch(error => {
                        console.error('ä»£ç†æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                        showStatus('ğŸ”§ è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°\nâŒ ä»£ç†æœåŠ¡å™¨è¿æ¥å¤±è´¥', 'error');
                    });
            } else {
                showStatus('ğŸ”§ è°ƒè¯•ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°\nå½“å‰ä½¿ç”¨ç›´æ¥è¿æ¥æ¨¡å¼', 'info');
            }
            
            console.log('æµè§ˆå™¨ä¿¡æ¯:', navigator.userAgent);
            console.log('HLSæ”¯æŒ:', Hls.isSupported());
            console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
        }
        
        function buildProxyUrl(m3u8Url, refererUrl) {
            const proxyBase = 'http://localhost:8001/proxy';
            const params = new URLSearchParams();
            params.append('url', m3u8Url);
            if (refererUrl) {
                params.append('referer', refererUrl);
            }
            return `${proxyBase}?${params.toString()}`;
        }
        
        function clearVideo() {
            const video = document.getElementById('videoPlayer');
            
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            video.src = '';
            video.load();
            
            showStatus('âœ… è§†é¢‘å·²æ¸…é™¤', 'success');
        }
        
        function testConnection() {
            const m3u8Url = document.getElementById('m3u8Url').value.trim();
            const refererUrl = document.getElementById('refererUrl').value.trim();
            const useProxy = document.getElementById('useProxy').checked;
            
            if (!m3u8Url) {
                showStatus('âŒ è¯·è¾“å…¥M3U8é“¾æ¥', 'error');
                return;
            }
            
            // å†³å®šæµ‹è¯•URL
            let testUrl = m3u8Url;
            if (useProxy) {
                testUrl = buildProxyUrl(m3u8Url, refererUrl);
                showStatus('ğŸ” æ­£åœ¨æµ‹è¯•ä»£ç†è¿æ¥...', 'info');
            } else {
                showStatus('ğŸ” æ­£åœ¨æµ‹è¯•ç›´æ¥è¿æ¥...', 'info');
            }
            
            // åˆ›å»ºä¸€ä¸ªéšè—çš„videoå…ƒç´ æ¥æµ‹è¯•
            const testVideo = document.createElement('video');
            testVideo.style.display = 'none';
            document.body.appendChild(testVideo);
            
            if (Hls.isSupported()) {
                const testHls = new Hls({
                    xhrSetup: function(xhr, url) {
                        if (!useProxy && refererUrl) {
                            console.log('æµ‹è¯•æ—¶éœ€è¦è®¾ç½®Referer:', refererUrl);
                            console.log('æç¤ºï¼šå»ºè®®ä½¿ç”¨ä»£ç†æ¨¡å¼è¿›è¡Œæµ‹è¯•');
                        }
                    }
                });
                
                testHls.on(Hls.Events.MANIFEST_PARSED, function() {
                    const successMsg = useProxy ? 'âœ… ä»£ç†è¿æ¥æµ‹è¯•æˆåŠŸï¼' : 'âœ… ç›´æ¥è¿æ¥æµ‹è¯•æˆåŠŸï¼';
                    showStatus(successMsg, 'success');
                    testHls.destroy();
                    document.body.removeChild(testVideo);
                });
                
                testHls.on(Hls.Events.ERROR, function(event, data) {
                    console.log('HLSæµ‹è¯•é”™è¯¯:', data);
                    if (data.fatal) {
                        let errorMsg;
                        if (useProxy) {
                            if (data.type === 'networkError') {
                                errorMsg = `âŒ ä»£ç†ç½‘ç»œé”™è¯¯ï¼šè¯·æ£€æŸ¥ä»£ç†æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ (${data.details})`;
                            } else {
                                errorMsg = `âŒ ä»£ç†è¿æ¥æµ‹è¯•å¤±è´¥: ${data.details}`;
                            }
                        } else {
                            errorMsg = `âŒ ç›´æ¥è¿æ¥æµ‹è¯•å¤±è´¥: ${data.details} (å»ºè®®å°è¯•ä»£ç†æ¨¡å¼)`;
                        }
                        showStatus(errorMsg, 'error');
                        testHls.destroy();
                        document.body.removeChild(testVideo);
                    }
                });
                
                testHls.loadSource(testUrl);
                testHls.attachMedia(testVideo);
            } else {
                showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾', 'error');
                document.body.removeChild(testVideo);
            }
        }
        
        function loadVideo() {
            const m3u8Url = document.getElementById('m3u8Url').value.trim();
            const refererUrl = document.getElementById('refererUrl').value.trim();
            const useProxy = document.getElementById('useProxy').checked;
            const video = document.getElementById('videoPlayer');
            
            if (!m3u8Url) {
                showStatus('âŒ è¯·è¾“å…¥M3U8é“¾æ¥', 'error');
                return;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„æ’­æ”¾å™¨
            if (hls) {
                hls.destroy();
            }
            
            // å†³å®šä½¿ç”¨çš„URL
            let finalUrl = m3u8Url;
            if (useProxy) {
                finalUrl = buildProxyUrl(m3u8Url, refererUrl);
                showStatus('ğŸ”„ æ­£åœ¨é€šè¿‡ä»£ç†åŠ è½½è§†é¢‘...', 'info');
                console.log('ä½¿ç”¨ä»£ç†URL:', finalUrl);
            } else {
                showStatus('ğŸ”„ æ­£åœ¨ç›´æ¥åŠ è½½è§†é¢‘...', 'info');
                console.log('ç›´æ¥è®¿é—®URL:', finalUrl);
            }
            
            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    xhrSetup: function(xhr, url) {
                        // è®¾ç½®è¯·æ±‚å¤´
                        xhr.setRequestHeader('Accept', '*/*');
                        xhr.setRequestHeader('Accept-Language', 'zh-CN,zh;q=0.9,en;q=0.8');
                        xhr.setRequestHeader('Cache-Control', 'no-cache');
                        xhr.setRequestHeader('Pragma', 'no-cache');
                        xhr.setRequestHeader('Sec-Fetch-Dest', 'empty');
                        xhr.setRequestHeader('Sec-Fetch-Mode', 'cors');
                        xhr.setRequestHeader('Sec-Fetch-Site', 'cross-site');
                        
                        if (!useProxy && refererUrl) {
                            console.log('éœ€è¦è®¾ç½®Referer:', refererUrl);
                            console.log('æç¤ºï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨ä»£ç†æœåŠ¡å™¨æ¥è®¾ç½®Refererå¤´');
                        }
                    }
                });
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    const statusMsg = useProxy ? 'âœ… é€šè¿‡ä»£ç†åŠ è½½æˆåŠŸï¼' : 'âœ… ç›´æ¥åŠ è½½æˆåŠŸï¼';
                    showStatus(statusMsg, 'success');
                    console.log('HLS manifest parsed, found ' + hls.levels.length + ' quality levels');
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.log('HLSæ’­æ”¾é”™è¯¯è¯¦æƒ…:', data);
                    if (data.fatal) {
                        let errorMsg;
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                if (useProxy) {
                                    errorMsg = `âŒ ä»£ç†ç½‘ç»œé”™è¯¯ï¼šè¯·æ£€æŸ¥ä»£ç†æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ\nè¯¦æƒ…: ${data.details || data.reason || 'æœªçŸ¥ç½‘ç»œé”™è¯¯'}`;
                                    console.log('ä»£ç†æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥: http://localhost:8001/');
                                } else {
                                    errorMsg = `âŒ ç½‘ç»œé”™è¯¯ï¼šæ— æ³•åŠ è½½è§†é¢‘ (å»ºè®®å°è¯•ä»£ç†æ¨¡å¼)\nè¯¦æƒ…: ${data.details || data.reason || 'æœªçŸ¥ç½‘ç»œé”™è¯¯'}`;
                                }
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                errorMsg = `âŒ åª’ä½“é”™è¯¯ï¼šè§†é¢‘æ ¼å¼ä¸æ”¯æŒæˆ–æŸå\nè¯¦æƒ…: ${data.details || data.reason || 'æœªçŸ¥åª’ä½“é”™è¯¯'}`;
                                break;
                            default:
                                if (useProxy) {
                                    errorMsg = `âŒ ä»£ç†æ’­æ”¾å¤±è´¥ï¼š${data.details || data.reason || 'æœªçŸ¥é”™è¯¯'}`;
                                } else {
                                    errorMsg = `âŒ æ’­æ”¾å¤±è´¥ï¼š${data.details || data.reason || 'æœªçŸ¥é”™è¯¯'} (å»ºè®®å°è¯•ä»£ç†æ¨¡å¼)`;
                                }
                                break;
                        }
                        showStatus(errorMsg, 'error');
                        console.error('HLSæ’­æ”¾é”™è¯¯:', data);
                    }
                });
                
                hls.loadSource(finalUrl);
                hls.attachMedia(video);
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // SafariåŸç”Ÿæ”¯æŒ
                video.src = finalUrl;
                const statusMsg = useProxy ? 'âœ… ä½¿ç”¨SafariåŸç”ŸHLSæ”¯æŒ (é€šè¿‡ä»£ç†)' : 'âœ… ä½¿ç”¨SafariåŸç”ŸHLSæ”¯æŒ';
                showStatus(statusMsg, 'success');
                
            } else {
                showStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒHLSæ’­æ”¾ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Safari', 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('ğŸ¬ M3U8æ’­æ”¾å™¨å·²å°±ç»ªï¼Œè¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'info');
            
            // æ£€æŸ¥HLSæ”¯æŒ
            if (Hls.isSupported()) {
                console.log('âœ… HLS.jsæ”¯æŒå·²å¯ç”¨');
            } else if (document.getElementById('videoPlayer').canPlayType('application/vnd.apple.mpegurl')) {
                console.log('âœ… åŸç”ŸHLSæ”¯æŒå·²å¯ç”¨ (Safari)');
            } else {
                showStatus('âš ï¸ å½“å‰æµè§ˆå™¨å¯èƒ½ä¸å®Œå…¨æ”¯æŒHLSæ’­æ”¾', 'error');
            }
        });
        
        // å›è½¦é”®å¿«é€ŸåŠ è½½
        document.getElementById('m3u8Url').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadVideo();
            }
        });
        
        document.getElementById('refererUrl').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadVideo();
            }
        });
    </script>
</body>
</html>